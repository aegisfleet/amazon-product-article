# AIエージェント開発ガイドライン

このドキュメントは、Amazon商品調査システムに携わるAIコーディングエージェントのためのベストプラクティスと必須手順をまとめたものです。

## 1. 必須の検証手順

いかなるタスクも、プロジェクト全体の健全性を確認するまでは完了とみなしてはなりません。以下のコマンドが正常に終了することを必ず確認してください：

- **ビルド**: `npm run build`
  - TypeScriptのコンパイルエラーがないことを確認してください。
- **テスト**: `npm test`
  - すべてのユニットテストおよびプロパティベースのテストがパスすることを確認してください。
  - プロンプトやコアロジックを修正した場合は、プロパティテストが依然として通ることを特に確認してください。

## 2. テスト駆動開発 (TDD)

可能な限りTDD（テスト駆動開発）のアプローチを採用してください。

1. **まずテストを書く**: `src/**/__tests__/` に期待される挙動を定義するテストケースを作成、または更新します。
2. **実装・修正**: テストをパスさせるために必要な最小限のコードを書きます。
3. **リファクタリング**: テストが通る状態を維持しながら、コードを整理します。

この手法は、正規表現やプロンプトを多用するこのシステムにおいて、エッジケースを捉えるためのプロパティベーステスト（`fast-check`を使用）において特に重要です。

## 3. プロンプトエンジニアリングと安全性

このシステムは、`src/jules/JulesInvestigator.ts` などに含まれる緻密に構成されたプロンプトに大きく依存しています。

- **構文破壊の回避**: 巨大なテンプレートリテラルを編集する際は、バックティックや波括弧の対応を壊さないよう細心の注意を払ってください。
- **フレーズの維持**: プロパティテストは、特定の指示やキーワードが含まれていることをチェックしています。プロンプトを整理・洗練させる際は、検証を壊さないよう慎重に行ってください。
- **検証の実行**: プロンプト生成クラスを変更した後は、必ず関連するテストスイート（例：`npm test src/jules/__tests__/JulesInvestigator.property.test.ts`）を実行してください。

## 4. セキュリティと認証情報

Amazon PA-APIの認証情報の取り扱いには、最優先でセキュリティを確保してください。

- **ログ出力の禁止**: `AMAZON_ACCESS_KEY` や `AMAZON_SECRET_KEY` をコンソール、ログ、ファイル、またはコミットメッセージに出力しないでください。
- **環境変数の利用**: 秘密情報には `process.env` を通じてアクセスしてください。キーをハードコードしたり、平文のファイルに保存したりしないでください。
- **エラーメッセージ**: API失敗時のエラーハンドリングで機密情報が漏洩しないようにしてください。

## 5. リポジトリの構造

混乱を避けるため、以下のディレクトリ構造を意識してください：

- `/scripts/`: PA-APIとの直接的なやりとりやデータ収集のためのPythonスクリプト。
- `/src/scripts/`: メインアプリケーションのTypeScript CLIエントリポイント。
- `/data/`: 商品データや調査結果が格納されます。明示的な指示がない限り、巨大な研究用ファイルや一時ファイルをコミットしないでください。

## 6. カテゴリグループ管理

カテゴリを親グループに整理する際は、**以下の2つのファイルを必ず同時に更新**してください：

| ファイル | 用途 |
|---|---|
| `static/js/category-dropdown.js` | フロントエンドのドロップダウンメニュー表示用 |
| `data/categorygroups.json` | Hugo テンプレートでの親カテゴリページ生成用 |

両ファイルの `categoryGroups` / カテゴリリストは同一の内容を維持する必要があります。片方だけ更新すると、UIとページ生成で不整合が発生します。

## 7. コミュニケーション

- 積極的に提案を行いつつも、既存のパターンに従ってください。
- 要件が曖昧な場合は、実装を進める前にユーザーに確認を行ってください。
- 変更内容は `walkthrough.md` に明確に記録してください。
