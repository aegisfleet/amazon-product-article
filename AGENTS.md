# AIエージェント開発ガイドライン

このドキュメントは、Amazon商品調査システムに携わるAIコーディングエージェントのためのベストプラクティスと必須手順をまとめたものです。

## 1. 必須の検証手順

いかなるタスクも、プロジェクト全体の健全性を確認するまでは完了とみなしてはなりません。以下のコマンドが正常に終了することを必ず確認してください：

- **Lint**: `npm run lint`
  - ESLintエラーが0件であることを確認してください（警告は許容されます）。
  - よくあるエラー例：
    - `no-base-to-string`: オブジェクトを文字列化すると `[object Object]` になる
    - `no-useless-escape`: 正規表現内の不要なエスケープ文字（例：文字クラス `[...]` 内の `\(` や `\)`）
    - `no-unsafe-member-access`: `any` 型へのメンバーアクセス
- **ビルド**: `npm run build`
  - TypeScriptのコンパイルエラーがないことを確認してください。
- **テスト**: `npm test`
  - すべてのユニットテストおよびプロパティベースのテストがパスすることを確認してください。
  - プロンプトやコアロジックを修正した場合は、プロパティテストが依然として通ることを特に確認してください。

> **重要**: GitHub Actions CIはLintエラーがあると失敗します。実装完了前に必ず `npm run lint` を実行し、エラーが0件であることを確認してください。

## 2. テスト駆動開発 (TDD)

可能な限りTDD（テスト駆動開発）のアプローチを採用してください。

1. **まずテストを書く**: `src/**/__tests__/` に期待される挙動を定義するテストケースを作成、または更新します。
2. **実装・修正**: テストをパスさせるために必要な最小限のコードを書きます。
3. **リファクタリング**: テストが通る状態を維持しながら、コードを整理します。

この手法は、正規表現やプロンプトを多用するこのシステムにおいて、エッジケースを捉えるためのプロパティベーステスト（`fast-check`を使用）において特に重要です。

## 3. プロンプトエンジニアリングと安全性

このシステムは、`src/jules/JulesInvestigator.ts` などに含まれる緻密に構成されたプロンプトに大きく依存しています。

- **構文破壊の回避**: 巨大なテンプレートリテラルを編集する際は、バックティックや波括弧の対応を壊さないよう細心の注意を払ってください。
- **フレーズの維持**: プロパティテストは、特定の指示やキーワードが含まれていることをチェックしています。プロンプトを整理・洗練させる際は、検証を壊さないよう慎重に行ってください。
- **検証の実行**: プロンプト生成クラスを変更した後は、必ず関連するテストスイート（例：`npm test src/jules/__tests__/JulesInvestigator.property.test.ts`）を実行してください。

## 4. セキュリティと認証情報

Amazon PA-APIの認証情報の取り扱いには、最優先でセキュリティを確保してください。

- **ログ出力の禁止**: `AMAZON_ACCESS_KEY` や `AMAZON_SECRET_KEY` をコンソール、ログ、ファイル、またはコミットメッセージに出力しないでください。
- **環境変数の利用**: 秘密情報には `process.env` を通じてアクセスしてください。キーをハードコードしたり、平文のファイルに保存したりしないでください。
- **エラーメッセージ**: API失敗時のエラーハンドリングで機密情報が漏洩しないようにしてください。

## 5. リポジトリの構造

混乱を避けるため、以下のディレクトリ構造を意識してください：

- `/scripts/`: PA-APIとの直接的なやりとりやデータ収集のためのPythonスクリプト。
- `/src/scripts/`: メインアプリケーションのTypeScript CLIエントリポイント。
- `/data/`: 商品データや調査結果が格納されます。明示的な指示がない限り、巨大な研究用ファイルや一時ファイルをコミットしないでください。

## 6. カテゴリグループ管理

カテゴリを親グループに整理する際は、**`data/categorygroups.json` のみ編集**してください。カテゴリの追加や修正の際は、各親グループ内でのソート順が**Unicodeコードポイント順（JavaScriptのデフォルトのsort順）**になるように維持してください。

> [!IMPORTANT]
> **ソートの優先順位**:
> 1. 英数字 (`0-9`, `A-Z`)
> 2. ひらがな
> 3. カタカナ
> 4. 漢字
>
> 読み（あいうえお順）ではなく、文字コード順で判定されます。迷った場合は `npm run sort:categories` を実行して自動整理してください。

| ファイル | 用途 |
|---|---|
| `data/categorygroups.json` | カテゴリ定義の唯一の情報源（Hugo テンプレート・フロントエンド共用） |
| `static/js/category-dropdown.js` | 実行時にJSONを動的読み込み（カテゴリデータのハードコード不要） |

> **Note**: `static/data/categorygroups.json` はビルド時に `npm run prebuild:hugo` で自動生成されます（Gitには含まれません）。

### 新規親カテゴリの追加

新しい親カテゴリを作成する場合は、`data/categorygroups.json` に加えて **親カテゴリページ用のMarkdownファイル** も作成する必要があります：

| ファイル | 用途 |
|---|---|
| `content/parent-category/{slug}.md` | 親カテゴリ一覧ページ（Hugo用） |

**ファイル形式** (`{slug}` は `categorygroups.json` で定義した slug 値)：

```markdown
---
title: "カテゴリ名"
description: "カテゴリ名カテゴリの商品一覧"
layout: "parent-category"
parent_category: "カテゴリ名"
---
```

このファイルが欠けていると、該当親カテゴリへのアクセス時に404エラーが発生します。

## 7. コミュニケーション

- 積極的に提案を行いつつも、既存のパターンに従ってください。
- 要件が曖昧な場合は、実装を進める前にユーザーに確認を行ってください。
- 変更内容は `walkthrough.md` に明確に記録してください。

## 8. PA-API 調査ツールの使用

商品調査時に以下のスクリプトを使用できます。**これらのスクリプトは編集せずに使用してください。**

| スクリプト | 用途 | 出力先 |
|---|---|---|
| `scripts/paapi_get_item.py` | 商品詳細取得 | `tmp/product_info.json` |
| `scripts/paapi_search_items.py` | 競合商品検索 | `tmp/search_results.json` |

### 使用例

```bash
# 商品詳細の取得
python scripts/paapi_get_item.py B09BZ59Y51

# 競合商品の検索（SearchIndex指定可能）
python scripts/paapi_search_items.py "枕カバー フランネル" --search-index HomeAndKitchen
```

### 利用可能な SearchIndex
- `All` (デフォルト)
- `Electronics`, `HomeAndKitchen`, `HealthPersonalCare`, `Sports`, `Books` 等

> **注意**: `tmp/` ディレクトリは `.gitignore` 対象です。調査結果ファイルはコミットしないでください。
