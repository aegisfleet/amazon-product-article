{{ define "main" }}
{{/* Variable Definitions moved to top */}}
{{ $currentAsin := .Params.asin }}
{{ $categories := .Params.categories }}
{{ $currentPrice := 0 }}
{{ if .Params.price }}
{{ $currentPrice = index (findRE "[0-9]+" (replace .Params.price "," "")) 0 | int }}
{{ end }}
{{ $currentScore := .Params.score | default 0 }}
{{ $allArticles := where (where .Site.RegularPages "Section" "articles") "Params.asin" "!=" $currentAsin }}

<div class="container" style="padding-top: var(--spacing-xl);">
    {{ partial "breadcrumb.html" . }}

    <article class="article-content">
        <header class="article-header">
            {{ if .Params.categories }}
            <span class="card-tag">{{ index .Params.categories 0 }}</span>
            {{ else }}
            {{ with .Params.category }}<span class="card-tag">{{ . }}</span>{{ end }}
            {{ end }}
            <h1 class="hero-title" style="margin-top: var(--spacing-sm);">{{ .Title }}</h1>
            <div class="article-meta">
                <span>å…¬é–‹æ—¥: {{ .Date.Format "2006å¹´01æœˆ02æ—¥" }}</span>
                {{ with .Params.author }}<span> â€¢ è‘—è€…: {{ . }}</span>{{ end }}
            </div>
        </header>

        {{/* åŒã˜ã‚«ãƒ†ã‚´ãƒªã®è¨˜äº‹ */}}
        {{ $related := $allArticles }}
        {{ if $categories }}
        {{ $firstCat := index $categories 0 }}
        {{ $related = where $related "Params.categories" "intersect" (slice $firstCat) }}
        {{ end }}

        <div id="related-products-section" style="display: none; margin-top: -1rem;">
            {{ if gt (len $related) 0 }}
            <section class="related-section">
                <h3 class="related-section-title">ğŸ“‚ åŒã˜ã‚«ãƒ†ã‚´ãƒªã®å•†å“</h3>
                <div class="related-grid">
                    {{ range first 4 $related }}
                    <a href="{{ .RelPermalink }}" class="pickup-card">
                        <div class="pickup-card-image">
                            {{ if .Params.images }}
                            <img src="{{ index .Params.images 0 }}" alt="{{ .Title }}" loading="lazy">
                            {{ else }}
                            <div class="pickup-card-noimage">ç”»åƒãªã—</div>
                            {{ end }}
                        </div>
                        <div class="pickup-card-content">
                            <p class="pickup-card-title">{{ .Title | truncate 30 }}</p>
                            <div class="pickup-card-meta">
                                {{ if .Params.score }}<span class="pickup-card-score">ğŸ† {{ .Params.score }}ç‚¹</span>{{
                                end }}
                                {{ if .Params.price }}<span class="pickup-card-price">{{ .Params.price }}</span>{{ end
                                }}
                            </div>
                        </div>
                    </a>
                    {{ end }}
                </div>
            </section>
            {{ end }}
        </div>

        {{ if .TableOfContents }}
        <nav class="table-of-contents" id="toc" style="display: none;">
            <details open>
                <summary>ğŸ“‘ ç›®æ¬¡</summary>
                {{ .TableOfContents }}
            </details>
        </nav>
        {{ end }}

        <div class="content">
            {{ .Content }}
        </div>

        <script>
            (function () {
                var toc = document.getElementById('toc');
                var relatedSection = document.getElementById('related-products-section');

                // Move TOC to before first H2
                if (toc) {
                    var firstH2 = document.querySelector('.content h2');
                    if (firstH2) {
                        firstH2.parentNode.insertBefore(toc, firstH2);
                    }
                    toc.style.display = 'block';
                }

                // Move Related Section to after Product Hero Card
                if (relatedSection) {
                    var heroCard = document.querySelector('.product-hero-card');
                    if (heroCard) {
                        // Insert after hero card
                        heroCard.parentNode.insertBefore(relatedSection, heroCard.nextSibling);
                    } else if (toc) {
                        // Fallback: Insert before TOC
                        toc.parentNode.insertBefore(relatedSection, toc);
                    } else {
                        var firstH2 = document.querySelector('.content h2');
                        if (firstH2) {
                            firstH2.parentNode.insertBefore(relatedSection, firstH2);
                        }
                    }
                    relatedSection.style.display = 'block';
                }
            })();
        </script>

    </article>

    {{/* åŒä¾¡æ ¼å¸¯ã®å•†å“ï¼ˆÂ±20%ç¯„å›²ã€åˆ¥ã‚«ãƒ†ã‚´ãƒªå„ªå…ˆï¼‰ */}}
    {{ if gt $currentPrice 0 }}
    {{ $minPrice := int (mul $currentPrice 0.8) }}
    {{ $maxPrice := int (mul $currentPrice 1.2) }}
    {{ $samePriceRange := slice }}
    {{ range $allArticles }}
    {{ $itemPrice := 0 }}
    {{ if .Params.price }}
    {{ $itemPrice = index (findRE "[0-9]+" (replace .Params.price "," "")) 0 | int }}
    {{ end }}
    {{ if and (ge $itemPrice $minPrice) (le $itemPrice $maxPrice) }}
    {{ $samePriceRange = $samePriceRange | append . }}
    {{ end }}
    {{ end }}

    {{ if gt (len $samePriceRange) 0 }}
    <section class="related-section"
        style="margin-top: var(--spacing-lg); border-top: 1px solid var(--color-border); padding-top: var(--spacing-lg);">
        <h3 class="related-section-title">ğŸ’° åŒä¾¡æ ¼å¸¯ã®ãŠã™ã™ã‚</h3>
        <div class="related-grid">
            {{ range first 4 (shuffle $samePriceRange) }}
            <a href="{{ .RelPermalink }}" class="pickup-card">
                <div class="pickup-card-image">
                    {{ if .Params.images }}
                    <img src="{{ index .Params.images 0 }}" alt="{{ .Title }}" loading="lazy">
                    {{ else }}
                    <div class="pickup-card-noimage">ç”»åƒãªã—</div>
                    {{ end }}
                </div>
                <div class="pickup-card-content">
                    <p class="pickup-card-title">{{ .Title | truncate 30 }}</p>
                    <div class="pickup-card-meta">
                        {{ if .Params.score }}<span class="pickup-card-score">ğŸ† {{ .Params.score }}ç‚¹</span>{{ end }}
                        {{ if .Params.price }}<span class="pickup-card-price">{{ .Params.price }}</span>{{ end }}
                    </div>
                </div>
            </a>
            {{ end }}
        </div>
    </section>
    {{ end }}
    {{ end }}

    {{/* åŒã‚¹ã‚³ã‚¢å¸¯ã®äººæ°—å•†å“ï¼ˆÂ±10ç‚¹ç¯„å›²ã€åˆ¥ã‚«ãƒ†ã‚´ãƒªå„ªå…ˆï¼‰ */}}
    {{ if gt $currentScore 0 }}
    {{ $minScore := sub $currentScore 10 }}
    {{ $maxScore := add $currentScore 10 }}
    {{ $sameScoreRange := where $allArticles "Params.score" "ge" $minScore }}
    {{ $sameScoreRange = where $sameScoreRange "Params.score" "le" $maxScore }}

    {{ if gt (len $sameScoreRange) 0 }}
    <section class="related-section"
        style="margin-top: var(--spacing-lg); border-top: 1px solid var(--color-border); padding-top: var(--spacing-lg);">
        <h3 class="related-section-title">â­ åŒã‚¹ã‚³ã‚¢å¸¯ã®äººæ°—å•†å“</h3>
        <div class="related-grid">
            {{ range first 4 (shuffle $sameScoreRange) }}
            <a href="{{ .RelPermalink }}" class="pickup-card">
                <div class="pickup-card-image">
                    {{ if .Params.images }}
                    <img src="{{ index .Params.images 0 }}" alt="{{ .Title }}" loading="lazy">
                    {{ else }}
                    <div class="pickup-card-noimage">ç”»åƒãªã—</div>
                    {{ end }}
                </div>
                <div class="pickup-card-content">
                    <p class="pickup-card-title">{{ .Title | truncate 30 }}</p>
                    <div class="pickup-card-meta">
                        {{ if .Params.score }}<span class="pickup-card-score">ğŸ† {{ .Params.score }}ç‚¹</span>{{ end }}
                        {{ if .Params.price }}<span class="pickup-card-price">{{ .Params.price }}</span>{{ end }}
                    </div>
                </div>
            </a>
            {{ end }}
        </div>
    </section>
    {{ end }}
    {{ end }}
</div>
{{ end }}