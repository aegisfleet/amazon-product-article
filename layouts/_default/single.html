{{ define "main" }}
<div class="container" style="padding-top: var(--spacing-xl);">
    <div class="back-links" style="margin-bottom: var(--spacing-lg);">
        <a href="{{ `` | relURL }}" class="back-link" style="display: inline-block; margin-right: 1rem;">← ホームに戻る</a>
        {{ if .Params.categories }}
        {{ $cat := index .Params.categories 0 }}
        {{ with site.GetPage (printf "categories/%s" $cat) }}
        <a href="{{ .RelPermalink }}" class="back-link" style="display: inline-block;">← {{ $cat }}に戻る</a>
        {{ end }}
        {{ else }}
        {{ with .Params.category }}
        {{ with site.GetPage (printf "categories/%s" .) }}
        <a href="{{ .RelPermalink }}" class="back-link" style="display: inline-block;">← {{ $.Params.category }}に戻る</a>
        {{ end }}
        {{ end }}
        {{ end }}
    </div>

    <article class="article-content">
        <header class="article-header">
            {{ if .Params.categories }}
            <span class="card-tag">{{ index .Params.categories 0 }}</span>
            {{ else }}
            {{ with .Params.category }}<span class="card-tag">{{ . }}</span>{{ end }}
            {{ end }}
            <h1 class="hero-title" style="margin-top: var(--spacing-sm);">{{ .Title }}</h1>
            <div class="article-meta">
                <span>公開日: {{ .Date.Format "2006年01月02日" }}</span>
                {{ with .Params.author }}<span> • 著者: {{ . }}</span>{{ end }}
            </div>
        </header>

        <div class="content">
            {{ .Content }}
        </div>

    </article>

    {{ $currentAsin := .Params.asin }}
    {{ $categories := .Params.categories }}
    {{ $related := where (where .Site.RegularPages "Section" "articles") "Params.asin" "!=" $currentAsin }}
    {{ if $categories }}
    {{ $firstCat := index $categories 0 }}
    {{ $related = where $related "Params.categories" "intersect" (slice $firstCat) }}
    {{ end }}

    {{ if gt (len $related) 0 }}
    <section class="related-articles"
        style="margin-top: var(--spacing-xl); border-top: 1px solid var(--color-border); padding-top: var(--spacing-lg);">
        <h2 style="margin-bottom: var(--spacing-md);">同じカテゴリーの最新記事</h2>
        <div class="product-grid">
            {{ range first 3 $related }}
            {{ partial "product-card.html" . }}
            {{ end }}
        </div>
    </section>
    {{ end }}
</div>
{{ end }}