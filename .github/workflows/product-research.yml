name: Product Research Pipeline

permissions:
  contents: read

on:
  schedule:
    # Run daily at 17:00 JST (08:00 UTC)
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      categories:
        description: 'Product category to search'
        required: true
        type: choice
        default: 'all'
        options:
          - all
          - electronics
          - wired_earphones
          - computers
          - kitchen
          - electric_kettles
          - home
          - appliances
          - women_beauty
          - women_fashion
          - women_appliances
          - women_health
          - kanpo
          - relaxation
          - storage
          - furniture
          - office
          - baby
          - pet
          - outdoor
          - automotive
          - diy
          - toys
          - gaming
          - music
          - watches
          - telework
          - kindle_books
          - novels
          - frozen_bento
          - meal_kits
          - emergency_foods
          - tea_leaves
          - smartphones
      max_results:
        description: 'Maximum results per category'
        required: false
        default: '10'
      asins:
        description: 'Specific ASINs to investigate (comma-separated, overrides categories)'
        required: false

jobs:
  product-search:
    runs-on: ubuntu-latest
    outputs:
      products-found: ${{ steps.search.outputs.products-found }}

    steps:
    - uses: actions/checkout@v6

    - name: Use Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Run product search
      id: search
      env:
        AMAZON_ACCESS_KEY: ${{ secrets.AMAZON_ACCESS_KEY }}
        AMAZON_SECRET_KEY: ${{ secrets.AMAZON_SECRET_KEY }}
        AMAZON_PARTNER_TAG: ${{ secrets.AMAZON_PARTNER_TAG }}
        PRODUCT_CATEGORIES: ${{ github.event.inputs.categories }}
        MAX_RESULTS_PER_CATEGORY: ${{ github.event.inputs.max_results || '10' }}
        INPUT_ASINS: ${{ github.event.inputs.asins }}
      run: npm run search:products

    - name: Upload product data
      uses: actions/upload-artifact@v6
      with:
        name: product-data
        path: data/products/
        retention-days: 7

  jules-investigation:
    needs: product-search
    if: needs.product-search.outputs.products-found == 'true'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Use Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Download product data
      uses: actions/download-artifact@v7
      with:
        name: product-data
        path: data/products/

    - name: Start Jules investigation sessions
      env:
        JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        JULES_SOURCE: sources/github/${{ github.repository }}
        JULES_STARTING_BRANCH: ${{ github.ref_name }}
        MAX_INVESTIGATION_PRODUCTS: '15'
      run: npm run investigate

    - name: Upload session data
      uses: actions/upload-artifact@v6
      with:
        name: session-data
        path: data/sessions/
        retention-days: 30

# Note: Article generation is handled in Phase 3 (deploy-articles.yml)
# triggered when Jules creates and merges PRs
